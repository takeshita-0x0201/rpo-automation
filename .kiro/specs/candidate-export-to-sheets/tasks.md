# Implementation Plan

- [ ] 1. データベーススキーマの拡張
  - [ ] 1.1 ai_evaluationsテーブルに送客関連フィールドを追加するマイグレーションファイルを作成
    - マイグレーションファイルに`sent_to_sheet`と`sent_to_sheet_at`カラムを追加
    - _Requirements: 2.1_

  - [ ] 1.2 マイグレーションを実行してテーブルを更新
    - Supabaseコマンドラインツールを使用してマイグレーションを適用
    - _Requirements: 2.1_

- [ ] 2. バックエンドAPIの実装
  - [ ] 2.1 候補者エクスポートAPIエンドポイントを実装
    - `export_selected_candidates`関数を修正して選択した候補者のデータを取得
    - 必要なデータを`ai_evaluations`と`candidates`テーブルから結合して取得
    - _Requirements: 1.1, 1.4_

  - [ ] 2.2 GASエンドポイント呼び出し機能を実装
    - 環境変数から`GAS_WEBHOOK_URL`を取得
    - HTTPクライアントを使用してGASエンドポイントにデータを送信
    - タイムアウト処理とエラーハンドリングを実装
    - _Requirements: 3.1, 4.1_

  - [ ] 2.3 送客状態更新機能を実装
    - スプレッドシート出力成功後に`ai_evaluations`テーブルを更新
    - `sent_to_sheet`と`sent_to_sheet_at`フィールドを設定
    - _Requirements: 2.1_

  - [ ] 2.4 候補者一覧表示APIを修正
    - `job_candidates_list`関数を修正して送客状態も含めて返すように変更
    - 統計情報に送客済み候補者数を追加
    - _Requirements: 2.2, 2.3_

- [ ] 3. Google Apps Script (GAS) の実装
  - [ ] 3.1 GASプロジェクトの作成とデプロイ
    - 新しいGASプロジェクトを作成
    - スクリプトプロパティにスプレッドシートIDを設定する機能を実装
    - _Requirements: 3.1, 4.2_

  - [ ] 3.2 doPost関数の実装
    - リクエストデータを解析する処理を実装
    - スプレッドシートを開く処理を実装
    - _Requirements: 3.1, 3.4_

  - [ ] 3.3 スプレッドシート出力機能の実装
    - 新しいシートを作成する処理を実装
    - 基本情報を書き込む処理を実装
    - 候補者データを書き込む処理を実装
    - スプレッドシートのフォーマット設定を実装
    - _Requirements: 3.2, 3.3_

  - [ ] 3.4 GASエンドポイントのデプロイと設定
    - ウェブアプリとしてデプロイ
    - アクセス権を設定
    - URLを環境変数に設定
    - _Requirements: 3.1, 4.1_

- [ ] 4. フロントエンドの実装
  - [ ] 4.1 候補者一覧画面の修正
    - 送客済み候補者にバッジを表示する機能を実装
    - 統計情報に送客済み候補者数を表示する機能を実装
    - _Requirements: 2.2, 2.3_

  - [ ] 4.2 exportToSheets関数の実装
    - 選択した候補者IDを取得する処理を実装
    - APIエンドポイントを呼び出す処理を実装
    - 処理中の表示を実装
    - _Requirements: 1.1, 1.2_

  - [ ] 4.3 結果表示機能の実装
    - 成功/エラーメッセージの表示を実装
    - スプレッドシートURLを開くオプションを実装
    - 送客済み状態の表示を更新する処理を実装
    - _Requirements: 1.2, 1.3, 2.2_

- [ ] 5. 環境変数の設定
  - [ ] 5.1 ローカル開発環境の設定
    - `.env`ファイルに`GAS_WEBHOOK_URL`を追加
    - _Requirements: 4.1_

  - [ ] 5.2 本番環境の設定
    - Supabase環境変数に`GAS_WEBHOOK_URL`を設定
    - _Requirements: 4.1_

- [ ] 6. テストとデバッグ
  - [ ] 6.1 バックエンドAPIのテスト
    - 候補者データ取得処理のテスト
    - GASエンドポイント呼び出し処理のテスト
    - データベース更新処理のテスト
    - _Requirements: 1.1, 2.1, 3.1_

  - [ ] 6.2 GASスクリプトのテスト
    - スプレッドシート出力処理のテスト
    - エラーハンドリングのテスト
    - _Requirements: 3.1, 3.2, 3.3_

  - [ ] 6.3 フロントエンドのテスト
    - 候補者選択と送客処理のテスト
    - 送客済み表示のテスト
    - _Requirements: 1.1, 2.2_

  - [ ] 6.4 エンドツーエンドテスト
    - 実際のデータを使用した送客プロセスのテスト
    - エラーケースのテスト
    - _Requirements: 1.1, 1.2, 1.3, 2.1, 2.2, 3.1, 3.4_