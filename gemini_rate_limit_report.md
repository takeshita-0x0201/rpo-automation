# Geminiのレート制限とコンテキストサイズ調査レポート

## 1. 各ノードで送信されるプロンプトの実際のサイズ

### 1.1 評価ノード（EvaluatorNode）
最もプロンプトサイズが大きいノードです。

**プロンプト構成:**
- ベースプロンプト（評価ルール、セマンティック理解等）: 約1,200文字
- 候補者レジュメ: 平均5,000文字
- 求人票（job_description）: 平均3,000文字
- 求人メモ（job_memo）: 平均2,000文字
- 構造化求人データ: 約1,500文字
- 構造化レジュメデータ: 約1,500文字
- 候補者基本情報: 約200文字

**合計: 約14,400文字（約3,600トークン）**

### 1.2 ギャップ分析ノード（GapAnalyzerNode）
評価結果を基に情報ギャップを分析します。

**プロンプト構成:**
- ベースプロンプト: 約1,000文字
- 評価結果サマリー: 約500文字

**合計: 約1,500文字（約375トークン）**

### 1.3 検索ノード（SearcherNode）
ギャップに基づいて追加情報を検索・要約します。

**プロンプト構成:**
- ベースプロンプト: 約800文字
- 検索結果（Tavily/シミュレーション）: 約2,000文字

**合計: 約2,800文字（約700トークン）**

### 1.4 レポートノード（ReporterNode）
最終評価レポートを生成します。

**プロンプト構成:**
- ベースプロンプト: 約1,200文字
- 評価履歴・追加情報: 約3,000文字

**合計: 約4,200文字（約1,050トークン）**

### 1.5 RAG検索ノード（RAGSearcherNode）
初期処理で類似ケースを検索します。

**プロンプト構成:**
- ベースプロンプト: 約500文字
- クエリと結果: 約1,500文字

**合計: 約2,000文字（約500トークン）**

## 2. プロンプトテンプレートのサイズ

### 2.1 評価プロンプトクラス（evaluation_base.py）
- ROLE_SETTING: 92文字
- EVALUATION_RULES: 313文字
- SEMANTIC_UNDERSTANDING: 489文字
- BALANCED_EVALUATION: 303文字
- **合計: 1,197文字**

### 2.2 スコアリング基準（scoring_criteria.py）
- SCORING_CATEGORIES: 1,526文字
- SCORING_GUIDELINES: 373文字
- OUTPUT_FORMAT: 700文字
- **合計: 約2,600文字**

### 2.3 要件ルール（requirement_rules.py）
- 必須要件と歓迎要件の区別ルール
- 強みと懸念の記載ルール
- **合計: 約1,000文字**

## 3. セマンティックガードやRAGで追加されるデータ量

### 3.1 RAG検索結果
- 類似ケース数: 5-10件
- 各ケースのサマリー: 約200文字
- 統計的洞察: 約300文字
- **合計: 約1,000-2,000文字**

### 3.2 セマンティックガード
- 営業経験判定の補足情報: 約300文字
- スキルマッピング情報: 約200文字
- **合計: 約500文字**

## 4. Gemini APIの制限値

### 4.1 Gemini 2.0 Flash

**無料版:**
- RPM（Requests Per Minute）: 15
- TPM（Tokens Per Minute）: 1,000,000
- RPD（Requests Per Day）: 1,500
- 同時セッション数: 3
- コンテキストウィンドウ: 1,000,000トークン

**有料版:**
- RPM: 2,000（推定）
- TPM: 4,000,000（推定）
- コンテキストウィンドウ: 1,000,000トークン

### 4.2 Gemini 2.5 Pro

**料金:**
- 入力: $1.25/100万トークン
- 出力: $10/100万トークン
- コンテキストウィンドウ: 1,000,000+トークン

**制限:**
- 無料版: 5 RPM、25 RPD
- 有料版: より高いRPM（詳細は公式ドキュメント参照）

## 5. 実際の使用量の見積もり

### 5.1 1候補者あたりの総API呼び出し数

**3サイクル実行時:**
1. 初期処理
   - RAG検索: 1回

2. 各サイクル（×3）
   - 評価: 1回
   - ギャップ分析: 1回
   - 検索: 3回（平均3つのギャップ）

3. 最終処理
   - レポート生成: 1回

**合計: 17回のAPI呼び出し**

### 5.2 1候補者あたりの総トークン使用量

- RAG検索: 500トークン
- 評価（3回）: 10,797トークン
- ギャップ分析（3回）: 1,125トークン
- 検索（9回）: 6,300トークン
- レポート生成: 1,050トークン

**合計: 約19,772トークン（約2万トークン）**

### 5.3 100人処理時の推定使用量

- **総API呼び出し数:** 1,700回
- **総トークン使用量:** 1,977,200トークン（約200万トークン）

### 5.4 処理時間の見積もり

**無料版（Gemini 2.0 Flash）:**
- RPM制限がボトルネック
- 100人処理: 約113分（1.9時間）

**有料版（Gemini 2.0 Flash）:**
- 100人処理: 約0.8分（50秒）

**コスト（Gemini 2.5 Pro）:**
- 入力トークン（80%）: 1,581,760トークン（$1.98）
- 出力トークン（20%）: 395,440トークン（$3.95）
- **合計コスト: $5.93**

## 6. 最適化の提案

### 6.1 即効性のある最適化

1. **プロンプトの圧縮**
   - 冗長な説明を削除
   - 構造化データの効率的な表現
   - 約20-30%のトークン削減が可能

2. **動的サイクル制御**
   - 高スコア（85点以上）: 1サイクルで終了
   - 低スコア（40点未満）: 1サイクルで終了
   - 境界線（40-85点）: フルサイクル実行
   - 約40%のAPI呼び出し削減が可能

### 6.2 中期的な最適化

1. **キャッシュシステムの導入**
   - 類似候補者の評価結果をキャッシュ
   - RAG検索結果の再利用
   - 約15-20%のAPI呼び出し削減

2. **バッチ処理の実装**
   - 複数候補者の並列処理
   - RPM制限の効率的な利用

### 6.3 長期的な最適化

1. **モデルの使い分け**
   - 初期スクリーニング: Gemini 2.0 Flash
   - 詳細評価: Gemini 2.5 Pro
   - コストと精度のバランス最適化

2. **ローカルモデルの活用**
   - 前処理や簡易フィルタリング
   - APIコールの削減

## 7. 推奨される実装方針

### 短期（1-2週間）
1. プロンプトの最適化による20%のトークン削減
2. 動的サイクル制御の実装
3. エラーハンドリングとリトライ機構の強化

### 中期（1-2ヶ月）
1. キャッシュシステムの構築
2. バッチ処理システムの実装
3. 詳細なメトリクス収集とモニタリング

### 長期（3-6ヶ月）
1. ハイブリッドモデルアーキテクチャ
2. 自動最適化システムの構築
3. コスト予測と最適化エンジン

## まとめ

現在のシステムは1候補者あたり約2万トークンを使用し、17回のAPI呼び出しを行います。無料版では100人処理に約2時間かかりますが、有料版では1分以内で処理可能です。コストは100人あたり約$6と非常にリーズナブルです。

最優先の最適化は：
1. **プロンプトの圧縮**（20-30%削減）
2. **動的サイクル制御**（40%のAPI呼び出し削減）
3. **キャッシュの活用**（15-20%の追加削減）

これらの最適化により、処理時間を50%以上短縮し、コストを30-40%削減できる見込みです。